// Generated by CoffeeScript 1.7.1
(function() {
  angular.module('EvolutionApp').controller('EvolutionCtrl', function($scope, utils, io, EvolutionCommons) {
    var loadGame;
    $scope.isMyTurn = function() {
      return ($scope.ec != null) && $scope.ec.isPlayerTurn($scope.playerId);
    };
    $scope.isMyTurnAndEvolutionPhase = function() {
      return $scope.isMyTurn() && $scope.isEvolutionPhase();
    };
    $scope.isEvolutionPhase = function() {
      var _ref;
      return ((_ref = $scope.ec) != null ? _ref.phase() : void 0) === 'Evolution';
    };
    $scope.isFoodPhase = function() {
      var _ref;
      return ((_ref = $scope.ec) != null ? _ref.phase() : void 0) === 'Food';
    };
    $scope.isExtinctionPhase = function() {
      var _ref;
      return ((_ref = $scope.ec) != null ? _ref.phase() : void 0) === 'Extinction';
    };
    $scope.me = function() {
      var _ref;
      return (_ref = $scope.ec) != null ? _ref.player($scope.playerId) : void 0;
    };
    $scope.passPhaseEvolution = function() {
      console.log("pass");
      io.emit('pass phase evolution');
    };
    $scope.endTurnEvolution = function(cardIndex, specieIndex) {
      console.log("next player");
      console.log(cardIndex);
      io.emit('end turn evolution', {
        cardIndex: cardIndex,
        specieIndex: specieIndex
      });
    };
    $scope.selectedCard = function() {
      var card, i, _i, _len, _ref;
      _ref = $scope.me().hand;
      for (i = _i = 0, _len = _ref.length; _i < _len; i = ++_i) {
        card = _ref[i];
        if (card.selected) {
          return i;
        }
      }
    };
    $scope.selectCard = function(cardIndex) {
      var card, _ref;
      if (!$scope.isMyTurn()) {
        return;
      }
      if ((_ref = $scope.ec.card($scope.selectedCard())) != null) {
        _ref.selected = false;
      }
      card = $scope.ec.card(cardIndex);
      card.selected = true;
      $scope.checkCompatibleEvolution(card);
    };
    $scope.feedSpecie = function(specieIndex) {
      if ($scope.ec.specie(specieIndex).compatible) {
        $scope.ec.feedSpecie(specieIndex);
        io.emit("end turn food", {
          specieIndex: specieIndex
        });
      }
    };
    $scope.useTrait = function(specieIndex, traitIndex) {};
    $scope.checkCompatibleEvolution = function(card) {
      var specie, _i, _len, _ref;
      _ref = $scope.me().species;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        specie = _ref[_i];
        specie.compatible = $scope.ec.checkCompatibleEvolution(specie, card);
      }
    };
    $scope.checkCompatibleFood = function() {
      var specie, _i, _len, _ref;
      _ref = $scope.me().species;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        specie = _ref[_i];
        specie.compatible = $scope.ec.checkCompatibleFood(specie);
      }
    };
    $scope.clearCompatible = function(card) {
      var specie, _i, _len, _ref;
      _ref = $scope.me().species;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        specie = _ref[_i];
        specie.compatible = false;
      }
    };
    $scope.selectSpecieEvolution = function(specieIndex) {
      var cardIndex, nextPhase;
      if ($scope.ec.specie(specieIndex).compatible) {
        cardIndex = $scope.selectedCard();
        nextPhase = $scope.ec.addTrait(specieIndex, cardIndex);
        $scope.clearCompatible();
        $scope.endTurnEvolution(cardIndex, specieIndex);
      }
    };
    $scope.selectSpecie = function(specieIndex) {
      if (!$scope.isMyTurn()) {
        return;
      }
      switch ($scope.ec.phase()) {
        case 'Evolution':
          $scope.selectSpecieEvolution(specieIndex);
          break;
        case 'Food':
          $scope.feedSpecie(specieIndex);
      }
    };
    $scope.currentPlayerClass = function(id) {
      var result;
      result = '';
      if (id === $scope.ec.currentPlayerId()) {
        result += 'currentPlayer';
      }
      if (id > $scope.playerId) {
        result += ' flex_order-1';
      }
      if ($scope.ec.game.players[id].finished) {
        result += ' finished';
      }
      return result;
    };
    loadGame = function() {
      var gameData;
      gameData = {
        gameId: (localStorage.gameId != null ? parseInt(localStorage.gameId) : null),
        playerId: (localStorage.playerId != null ? parseInt(localStorage.playerId) : null)
      };
      io.emit("load game", gameData);
    };
    $scope.restartGame = function() {
      io.emit("restart game");
    };
    io.on("get id", function(data) {
      return localStorage;
    });
    io.on("connect", function() {
      loadGame();
    });
    io.on("evolution connect", function() {
      location.reload();
    });
    io.on("game loaded", function(data) {
      $scope.ec = new EvolutionCommons(data.game);
      console.log("Game: " + data.gameId + ", player: " + data.playerId);
      localStorage.setItem("playerId", data.playerId);
      localStorage.setItem("gameId", data.gameId);
      $scope.playerId = data.playerId;
      $scope.$apply();
    });
    io.on("next player evolution", function(data) {
      var player, previousPlayerId;
      previousPlayerId = $scope.ec.currentPlayerId();
      $scope.ec.nextPlayer();
      player = $scope.ec.game.players[previousPlayerId];
      player.species[data.specieIndex].traits.push(data.card);
      if (player.cardNumber != null) {
        player.cardNumber--;
        if (player.cardNumber === 0) {
          player.finished = true;
        }
      }
      $scope.$apply();
    });
    io.on("player passed evolution", function(data) {
      var nextPhase;
      nextPhase = $scope.ec.playerPassedEvolution();
      $scope.$apply();
    });
    io.on("next player food", function(data) {
      var nextPhase;
      nextPhase = $scope.ec.feedSpecie(data.specieIndex);
      $scope.$apply();
    });
    io.on("phase food", function(data) {
      var player, specie, _i, _j, _len, _len1, _ref, _ref1;
      $scope.ec.game.foodAmount = data.foodAmount;
      _ref = $scope.ec.game.players;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        player = _ref[_i];
        player.finished = false;
      }
      _ref1 = $scope.me().species;
      for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
        specie = _ref1[_j];
        $scope.ec.checkCompatibleFood(specie);
      }
      $scope.$apply();
    });
    io.on("error", function(data) {
      console.log(data.description.stack);
      throw data;
    });
    io.on("game error", function(data) {
      console.log(data);
    });
    io.on("evolution error", function(data) {
      $scope.ec.players[data.ec.currentPlayerId()].species[data.specieId].traits.pop();
      console.log("ahah t'as perdu ta carte :D");
    });
  });

}).call(this);

//# sourceMappingURL=evolution.map
