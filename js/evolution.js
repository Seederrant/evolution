// Generated by CoffeeScript 1.7.1
(function() {
  angular.module('EvolutionApp').controller('EvolutionCtrl', function($scope, utils, io, EvolutionCommons) {
    var loadGame, scopeApply;
    $scope.selectedCard = null;
    scopeApply = function() {
      $scope.refreshIds();
      $scope.$apply();
    };
    $scope.refreshIds = function() {
      var card, i, j, k, player, specie, trait, _i, _j, _k, _l, _len, _len1, _len2, _len3, _len4, _m, _ref, _ref1, _ref2, _ref3;
      _ref = $scope.ec.game.players;
      for (i = _i = 0, _len = _ref.length; _i < _len; i = ++_i) {
        player = _ref[i];
        player.id = i;
        _ref1 = player.species;
        for (j = _j = 0, _len1 = _ref1.length; _j < _len1; j = ++_j) {
          specie = _ref1[j];
          specie.id = j;
          _ref2 = specie.traits;
          for (k = _k = 0, _len2 = _ref2.length; _k < _len2; k = ++_k) {
            trait = _ref2[k];
            trait.id = k;
          }
        }
        if (player.hand != null) {
          _ref3 = player.hand;
          for (j = _l = 0, _len3 = _ref3.length; _l < _len3; j = ++_l) {
            card = _ref3[j];
            card.id = j;
            for (k = _m = 0, _len4 = card.length; _m < _len4; k = ++_m) {
              trait = card[k];
              trait.id = k;
            }
          }
        }
      }
    };
    $scope.isMyTurn = function() {
      return ($scope.ec != null) && $scope.ec.isPlayerTurn($scope.playerId);
    };
    $scope.isMyTurnAndEvolutionPhase = function() {
      return $scope.isMyTurn() && $scope.isEvolutionPhase();
    };
    $scope.canPassFoodAndFoodPhase = function() {
      return $scope.isFoodPhase() && $scope.ec.canPassFood();
    };
    $scope.showPassButton = function() {
      return $scope.isMyTurnAndEvolutionPhase() || $scope.canPassFoodAndFoodPhase();
    };
    $scope.isEvolutionPhase = function() {
      var _ref;
      return ((_ref = $scope.ec) != null ? _ref.phase() : void 0) === 'Evolution';
    };
    $scope.isFoodPhase = function() {
      var _ref;
      return ((_ref = $scope.ec) != null ? _ref.phase() : void 0) === 'Food';
    };
    $scope.isExtinctionPhase = function() {
      var _ref;
      return ((_ref = $scope.ec) != null ? _ref.phase() : void 0) === 'Extinction';
    };
    $scope.me = function() {
      var _ref;
      return (_ref = $scope.ec) != null ? _ref.player($scope.playerId) : void 0;
    };
    $scope.isMe = function(playerIndex) {
      return $scope.playerId === playerIndex;
    };
    $scope.passPhaseEvolution = function() {
      console.log("pass evolution");
      io.emit('pass phase evolution');
    };
    $scope.passPhaseFood = function() {
      console.log("pass food");
      io.emit('pass phase food');
    };
    $scope.passPhase = function() {
      switch ($scope.ec.phase()) {
        case 'Evolution':
          $scope.passPhaseEvolution();
          break;
        case 'Food':
          $scope.passPhaseFood();
      }
      $scope.refreshIds();
    };
    $scope.endTurnEvolution = function(specieIndex, addSpecie) {
      if (addSpecie == null) {
        addSpecie = false;
      }
      console.log("next player");
      io.emit('end turn evolution', {
        selectedCard: $scope.selectedCard,
        specieIndex: specieIndex,
        addSpecie: addSpecie
      });
      $scope.selectedCard = null;
    };
    $scope.hasCardSelected = function() {
      return $scope.selectedCard !== null;
    };
    $scope.selectCard = function(cardIndex, traitIndex) {
      var trait;
      if (!$scope.isMyTurn()) {
        return;
      }
      if ($scope.ec.phase() !== "Evolution") {
        return;
      }
      $scope.selectedCard = {
        cardIndex: cardIndex,
        traitIndex: traitIndex
      };
      trait = $scope.ec.card(cardIndex)[traitIndex];
      $scope.checkCompatibleEvolution(trait);
    };
    $scope.feedSpecie = function(specieIndex) {
      if ($scope.ec.specie(specieIndex).compatible) {
        $scope.ec.feedSpecie(specieIndex);
        io.emit("end turn food", {
          specieIndex: specieIndex
        });
      }
    };
    $scope.useTrait = function(specieIndex, traitIndex) {};
    $scope.checkCompatibleEvolution = function(card) {
      var specie, _i, _len, _ref;
      _ref = $scope.me().species;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        specie = _ref[_i];
        $scope.ec.checkCompatibleEvolution(specie, card);
      }
    };
    $scope.checkCompatibleFood = function() {
      var specie, _i, _len, _ref;
      _ref = $scope.me().species;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        specie = _ref[_i];
        $scope.ec.checkCompatibleFood(specie);
      }
    };
    $scope.isHighlightedSpecie = function(specie, playerId) {
      return specie.compatible && $scope.isMyTurn();
    };
    $scope.isHighlightedTrait = function(trait, playerId) {
      return trait.compatible && playerId === $scope.playerId;
    };
    $scope.isHighlightedCardTrait = function(cardIndex, traitIndex) {
      var _ref, _ref1;
      return ((_ref = $scope.selectedCard) != null ? _ref.cardIndex : void 0) === cardIndex && ((_ref1 = $scope.selectedCard) != null ? _ref1.traitIndex : void 0) === traitIndex;
    };
    $scope.clearCompatible = function() {
      var player, specie, trait, _i, _j, _k, _len, _len1, _len2, _ref, _ref1, _ref2;
      _ref = $scope.ec.game.players;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        player = _ref[_i];
        _ref1 = player.species;
        for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
          specie = _ref1[_j];
          specie.compatible = false;
          _ref2 = specie.traits;
          for (_k = 0, _len2 = _ref2.length; _k < _len2; _k++) {
            trait = _ref2[_k];
            trait.compatible = false;
          }
        }
      }
    };
    $scope.selectSpecieEvolution = function(specieIndex) {
      var nextPhase;
      if ($scope.ec.specie(specieIndex).compatible) {
        nextPhase = $scope.ec.addTrait(specieIndex, $scope.selectedCard);
        $scope.clearCompatible();
        $scope.endTurnEvolution(specieIndex);
      }
    };
    $scope.selectSpecie = function(specieIndex) {
      if (!$scope.isMyTurn()) {
        return;
      }
      switch ($scope.ec.phase()) {
        case 'Evolution':
          $scope.selectSpecieEvolution(specieIndex);
          break;
        case 'Food':
          $scope.feedSpecie(specieIndex);
      }
      $scope.refreshIds();
    };
    $scope.addSpecie = function() {
      $scope.ec.addSpecie($scope.selectedCard);
      $scope.clearCompatible();
      $scope.endTurnEvolution(-1, true);
    };
    $scope.currentPlayerClass = function(id) {
      var result;
      result = '';
      if (id === $scope.ec.currentPlayerId()) {
        result += 'currentPlayer';
      }
      if (id > $scope.playerId) {
        result += ' flex_order-1';
      }
      if ($scope.ec.game.players[id].finished) {
        result += ' finished';
      }
      return result;
    };
    loadGame = function() {
      var gameData;
      gameData = {
        gameId: (localStorage.gameId != null ? parseInt(localStorage.gameId) : null),
        playerId: (localStorage.playerId != null ? parseInt(localStorage.playerId) : null)
      };
      io.emit("load game", gameData);
    };
    $scope.restartGame = function() {
      io.emit("restart game");
    };
    $scope.initializeFoodPhase = function() {
      $scope.clearCompatible();
      $scope.checkCompatibleFood();
    };
    $scope.initializeEvolutionPhase = function() {};
    $scope.initializeGame = function() {
      switch ($scope.ec.phase()) {
        case 'Evolution':
          $scope.initializeEvolutionPhase();
          break;
        case 'Food':
          $scope.initializeFoodPhase();
      }
    };
    io.on("get id", function(data) {
      return localStorage;
    });
    io.on("connect", function() {
      loadGame();
    });
    io.on("evolution connect", function() {
      location.reload();
    });
    io.on("game loaded", function(data) {
      $scope.ec = new EvolutionCommons(data.game);
      console.log("Game: " + data.gameId + ", player: " + data.playerId);
      localStorage.setItem("playerId", data.playerId);
      localStorage.setItem("gameId", data.gameId);
      $scope.playerId = data.playerId;
      $scope.initializeGame();
      scopeApply();
    });
    io.on("next player evolution", function(data) {
      var player, previousPlayerId;
      previousPlayerId = $scope.ec.currentPlayerId();
      $scope.ec.nextPlayer();
      player = $scope.ec.game.players[previousPlayerId];
      if (!data.addSpecie) {
        player.species[data.specieIndex].traits.push({
          shortName: data.trait
        });
      } else {
        $scope.ec.createSpecie(player);
      }
      if (player.cardNumber != null) {
        player.cardNumber--;
        if (player.cardNumber === 0) {
          player.finished = true;
        }
      }
      scopeApply();
    });
    io.on("player passed evolution", function(data) {
      var nextPhase;
      nextPhase = $scope.ec.playerPassedEvolution();
      scopeApply();
    });
    io.on("next player food", function(data) {
      var nextPhase;
      console.log("next player food");
      nextPhase = $scope.ec.feedSpecie(data.specieIndex);
      $scope.clearCompatible();
      if (!nextPhase) {
        $scope.checkCompatibleFood();
      }
    });
    io.on("player passed food", function(data) {
      var nextPhase;
      nextPhase = $scope.ec.playerPassedFood();
      scopeApply();
    });
    io.on("phase food", function(data) {
      var player, _i, _len, _ref;
      console.log("phase food");
      $scope.ec.game.foodAmount = data.foodAmount;
      _ref = $scope.ec.game.players;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        player = _ref[_i];
        player.finished = false;
      }
      $scope.initializeFoodPhase();
      scopeApply();
    });
    io.on("phase evolution", function(data) {
      var i, player, _i, _len, _ref;
      console.log("phase evolution");
      $scope.ec.clearExtinctedSpecies();
      $scope.me().hand = data.hand;
      $scope.ec.game.cardNumberInDeck = data.number;
      _ref = $scope.ec.game.players;
      for (i = _i = 0, _len = _ref.length; _i < _len; i = ++_i) {
        player = _ref[i];
        player.cardNumber = data.playersCardNumber[i];
      }
      scopeApply();
    });
    io.on("error", function(data) {
      console.log(data.description.stack);
      throw data;
    });
    io.on("game error", function(data) {
      console.log(data);
    });
    io.on("evolution error", function(data) {
      $scope.ec.players[data.ec.currentPlayerId()].species[data.specieId].traits.pop();
      console.log("ahah t'as perdu ta carte :D");
    });
  });

}).call(this);

//# sourceMappingURL=evolution.map
